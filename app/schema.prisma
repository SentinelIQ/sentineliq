datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  workspaceMembers          WorkspaceMember[]
  ownedWorkspaces           Workspace[]     @relation("WorkspaceOwner")
  contactFormMessages       ContactFormMessage[]
  notifications             Notification[]
  auditLogs                 AuditLog[]
  workspaceInvitations      WorkspaceInvitation[]
  
  // Campo para rastrear onboarding
  hasCompletedOnboarding    Boolean         @default(false)
  currentWorkspaceId        String?
  currentWorkspace          Workspace?      @relation("CurrentWorkspace", fields: [currentWorkspaceId], references: [id])
  
  // 2FA (Two-Factor Authentication)
  twoFactorEnabled          Boolean         @default(false)
  twoFactorSecret           String?
  twoFactorBackupCodes      String[]        @default([])
  
  // Security
  loginAttempts             Int             @default(0)
  lockedUntil               DateTime?
  lastLoginAt               DateTime?
  lastLoginIp               String?
  
  // Refresh Token Rotation
  refreshTokens             RefreshToken[]
  
  // Notification Preferences
  notificationPreferences   NotificationPreference?
  pushSubscriptions         PushSubscription[]
  
  // Aegis Relations
  assignedAlerts            Alert[]                @relation("AlertAssignee")
  assignedIncidents         Incident[]             @relation("IncidentAssignee")
  investigatedCases         Case[]                 @relation("CaseInvestigator")
  createdObservables        Observable[]           @relation("ObservableCreator")
  collectedEvidence         Evidence[]             @relation("EvidenceCollector")
  custodyActions            CustodyLog[]           @relation("CustodyUser")
  assignedTasks             Task[]                 @relation("TaskAssignee")
  timelineEvents            TimelineEvent[]        @relation("TimelineUser")
  investigationNotes        InvestigationNote[]    @relation("NoteAuthor")
  
  // MITRE Relations
  createdTTPs               TTP[]
}

model Workspace {
  id                String              @id @default(uuid())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  name              String
  slug              String              @unique
  description       String?
  
  ownerId           String
  owner             User                @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  members           WorkspaceMember[]
  currentUsers      User[]              @relation("CurrentWorkspace")
  notifications     Notification[]
  notificationProviders NotificationProvider[]
  ticketProviders   TicketProvider[]
  auditLogs         AuditLog[]
  invitations       WorkspaceInvitation[]
  
  // Payment & Subscription (workspace gerencia)
  paymentProcessorUserId    String?         @unique
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted', 'trialing'
  subscriptionPlan          String?         // 'free', 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)
  
  // Trial
  trialEndsAt               DateTime?
  trialUsed                 Boolean         @default(false)
  
  // Coupons
  appliedCoupon             String?
  couponDiscountPercent     Int?
  
  // Billing Information (for invoices and NF-e)
  legalName                 String?         // Razão social (legal company name)
  cnpj                      String?         // CNPJ/CPF for Brazilian tax documents
  stateRegistration         String?         // Inscrição estadual
  billingAddress            String?         // Complete billing address
  billingCity               String?
  billingState              String?
  billingZipCode            String?
  billingCountry            String?         @default("BR")
  
  // Configurações do workspace
  settings          Json?
  isActive          Boolean             @default(true)
  deletedAt         DateTime?           // ✅ Soft delete timestamp for garbage collection
  
  // IP Whitelisting (for enterprise workspaces)
  ipWhitelist       String[]            @default([])
  ipWhitelistEnabled Boolean            @default(false)
  
  // ✅ Workspace Branding (logo and colors)
  logoUrl           String?             // URL to workspace logo (uploaded to S3/CDN)
  primaryColor      String?             // Hex color for primary brand color (e.g., "#3b82f6")
  secondaryColor    String?             // Hex color for secondary brand color
  
  // ✅ Storage Quota Management
  storageUsed       BigInt              @default(0) // Storage used in bytes
  storageQuota      BigInt              @default(1073741824) // 1GB default quota in bytes
  
  // ✅ Session Security Configuration
  sessionTimeout    Int                 @default(1800) // Session timeout in seconds (default: 30 minutes)
  
  // Aegis Relations
  alerts            Alert[]
  incidents         Incident[]
  cases             Case[]
  observables       Observable[]
  pushSubscriptions PushSubscription[]
  
  aegisConfig            AegisConfig?
  
  // MITRE Relations
  ttps              TTP[]
  
  // Eclipse Relations
  eclipseBrands         EclipseBrand[]          @relation("EclipseBrandWorkspace")
  brandMonitors         BrandMonitor[]          @relation("BrandMonitorWorkspace")
  brandAlerts           BrandAlert[]            @relation("BrandAlertWorkspace")
  brandInfringements    BrandInfringement[]     @relation("BrandInfringementWorkspace")
  infringementActions   InfringementAction[]    @relation("InfringementActionWorkspace")
  brandAggregations     BrandAlertAggregation[] @relation("BrandAlertAggregationWorkspace")
  
  // Feature Management
  featureOverrides      WorkspaceFeatureOverride[]
  featureUsageLogs      FeatureUsageLog[]
  
  // Subscription History (for conversion funnel analytics)
  subscriptionHistory   WorkspaceSubscriptionHistory[]
}

// Track subscription plan changes for analytics
model WorkspaceSubscriptionHistory {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now())
  
  workspaceId     String
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  fromPlan        String?   // Previous plan ('free', 'hobby', 'pro', or null for initial)
  toPlan          String    // New plan ('free', 'hobby', 'pro')
  
  reason          String?   // 'upgrade', 'downgrade', 'trial_end', 'manual', etc
  metadata        Json?     // Additional context (coupon, discount, etc)
  
  @@index([workspaceId, createdAt])
  @@index([toPlan, createdAt])
  @@index([fromPlan, toPlan, createdAt])
}

model WorkspaceMember {
  id                String              @id @default(uuid())
  createdAt         DateTime            @default(now())
  
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workspaceId       String
  workspace         Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  role              WorkspaceRole       @default(MEMBER)
  
  @@unique([userId, workspaceId])
}

enum WorkspaceRole {
  OWNER
  ADMIN
  MEMBER
}

// Analytics Models
model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                     Int       @id @default(autoincrement())
  createdAt              DateTime  @default(now())
  message                String
  level                  String
}

model ContactFormMessage {
  id                     String    @id @default(uuid())
  createdAt              DateTime  @default(now())
  
  content                String
  isRead                 Boolean   @default(false)
  repliedAt              DateTime?
  
  userId                 String
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// System Logs (technical logs - errors, performance, debug)
model SystemLog {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  
  level       LogLevel
  message     String
  component   String   // 'job', 'api', 'webhook', etc
  metadata    Json?
  
  @@index([level, createdAt])
  @@index([component, createdAt])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

// Audit Logs (user actions, compliance)
model AuditLog {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      AuditAction
  resource    String   // 'workspace', 'member', 'payment', 'alert', etc
  resourceId  String?
  
  description String
  metadata    Json?    // Dados antes/depois, IPs, etc
  
  ipAddress   String?
  userAgent   String?
  
  @@index([workspaceId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

enum AuditAction {
  // Workspace Actions
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  WORKSPACE_DELETED
  WORKSPACE_SECURITY_UPDATED
  DATA_EXPORTED
  
  // Member Actions
  MEMBER_ADDED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED
  OWNERSHIP_TRANSFERRED
  
  // Payment Actions
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  SUBSCRIPTION_CHANGED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_DELETED
  
  // Provider Actions
  PROVIDER_CONFIGURED
  
  // Aegis Module - Alerts
  ALERT_CREATED
  ALERT_UPDATED
  ALERT_ESCALATED
  
  // Aegis Module - Incidents
  INCIDENT_CREATED
  INCIDENT_UPDATED
  INCIDENT_RESOLVED
  
  // Aegis Module - Cases
  CASE_CREATED
  CASE_UPDATED
  CASE_CLOSED
  
  // Aegis Module - Evidence
  EVIDENCE_UPLOADED
  EVIDENCE_ACCESSED
  
  // Settings
  SETTINGS_UPDATED
  
  // MITRE Module
  TTP_LINKED
  TTP_UNLINKED
  TTP_OCCURRENCE_UPDATED
  TTP_SYNCED
  
  // Eclipse Module - Brands
  ECLIPSE_BRAND_CREATED
  ECLIPSE_BRAND_UPDATED
  ECLIPSE_BRAND_DELETED
  
  // Eclipse Module - Monitors
  ECLIPSE_MONITOR_CREATED
  ECLIPSE_MONITOR_UPDATED
  
  // Eclipse Module - Alerts
  ECLIPSE_ALERT_CREATED
  ECLIPSE_ALERT_ACKNOWLEDGED
  ECLIPSE_ALERT_ESCALATED
  
  // Eclipse Module - Infringements
  ECLIPSE_INFRINGEMENT_CREATED
  ECLIPSE_INFRINGEMENT_UPDATED
  
  // Eclipse Module - Actions
  ECLIPSE_ACTION_CREATED
  ECLIPSE_ACTION_COMPLETED
  
  // Feature Management
  FEATURE_USED
  FEATURE_DENIED
  FEATURES_UPDATED
  
  // Admin Actions
  ADMIN_ACTION
  ADMIN_SUSPEND_USER
  ADMIN_SUSPEND_WORKSPACE
  ADMIN_RESET_PASSWORD
  ADMIN_DELETE_USER
  ADMIN_UPDATE_QUOTAS
  ADMIN_PROCESS_REFUND
  ADMIN_OVERRIDE_SUBSCRIPTION
  ADMIN_PAUSE_JOB
  ADMIN_RESUME_JOB
  ADMIN_UPDATE_JOB_SCHEDULE
  ADMIN_RETRY_DLQ_JOB
  ADMIN_RESOLVE_DLQ_JOB
  
  // User Management
  UPDATE_USER_ADMIN_STATUS
}

// In-app Notifications
model Notification {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  
  type        NotificationType
  title       String
  message     String
  link        String?
  
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  eventType   String   // 'member_added', 'payment_failed', 'incident_critical', etc
  metadata    Json?
  
  @@index([userId, isRead])
  @@index([workspaceId, createdAt])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  CRITICAL
}

// Notification Provider Configuration (per workspace)
model NotificationProvider {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  provider    NotificationProviderType
  isEnabled   Boolean  @default(true)
  config      Json     // Configurações específicas (webhooks, API keys, etc)
  
  // Quais eventos devem acionar este provider
  eventTypes  String[] // ['member_added', 'payment_failed', etc]
  
  @@unique([workspaceId, provider])
}

enum NotificationProviderType {
  EMAIL
  SLACK
  DISCORD
  WEBHOOK
  TELEGRAM
  TEAMS
}

// Ticket Provider Configuration (per workspace)
model TicketProvider {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  provider    TicketProviderType
  isEnabled   Boolean  @default(true)
  config      Json     // Credenciais específicas (API tokens, URLs, etc)
  
  @@unique([workspaceId, provider])
}

enum TicketProviderType {
  JIRA
  SERVICENOW
  AZURE_DEVOPS
}

// Workspace Invitations (email invites for non-users)
model WorkspaceInvitation {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  email       String
  role        WorkspaceRole @default(MEMBER)
  token       String   @unique
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  invitedById String
  invitedBy   User     @relation(fields: [invitedById], references: [id])
  
  acceptedAt  DateTime?
  
  @@unique([workspaceId, email])
}

// Refresh Token Model for JWT rotation
model RefreshToken {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  token       String   @unique
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Track token usage for security
  lastUsedAt  DateTime?
  usageCount  Int      @default(0)
  
  // Track device/location
  ipAddress   String?
  userAgent   String?
  
  // Revoked flag
  isRevoked   Boolean  @default(false)
  revokedAt   DateTime?
  
  @@index([userId, isRevoked])
  @@index([token, expiresAt])
}

// ✅ Ownership Transfer Confirmation (email-based confirmation for security)
model OwnershipTransferConfirmation {
  id                String    @id @default(uuid())
  createdAt         DateTime  @default(now())
  expiresAt         DateTime  // 24 hours expiry
  
  token             String    @unique
  confirmedAt       DateTime?
  
  workspaceId       String
  currentOwnerId    String
  newOwnerId        String
  
  // Security tracking
  ipAddress         String?
  userAgent         String?
  
  @@index([token])
  @@index([workspaceId])
  @@index([newOwnerId])
}

// ✅ User Notification Preferences (granular control per user)
model NotificationPreference {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email notifications enabled/disabled
  emailEnabled          Boolean  @default(true)
  
  // In-app notifications enabled/disabled
  inAppEnabled          Boolean  @default(true)
  
  // Specific event types disabled (array of event type strings)
  disabledEventTypes    String[] @default([])
  
  // Provider-specific preferences
  slackEnabled          Boolean  @default(true)
  discordEnabled        Boolean  @default(true)
  webhookEnabled        Boolean  @default(true)
  telegramEnabled       Boolean  @default(true)
  teamsEnabled          Boolean  @default(true)
  
  // Digest preferences
  digestEnabled         Boolean  @default(false)
  digestFrequency       DigestFrequency @default(DAILY)
  digestTime            String   @default("09:00") // HH:mm format
  lastDigestSentAt      DateTime?
  
  // Do Not Disturb schedule
  dndEnabled            Boolean  @default(false)
  dndStartTime          String?  // HH:mm format
  dndEndTime            String?  // HH:mm format
  
  // Push notifications preference (Web Push API)
  pushEnabled           Boolean  @default(false)
  
  @@index([userId])
}

enum DigestFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

// ✅ Push Subscription (Web Push API subscriptions per device)
model PushSubscription {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Push subscription details from PushManager API
  endpoint    String    @unique
  keys        Json      // {p256dh: string, auth: string}
  
  // Device info for management
  userAgent   String?
  deviceName  String?   // Optional friendly name
  
  // Track usage
  lastUsedAt  DateTime  @default(now())
  
  @@index([userId])
  @@index([workspaceId])
  @@index([endpoint])
}

// ✅ Notification Delivery Log (track delivery status and retries)
model NotificationDeliveryLog {
  id                String   @id @default(uuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  notificationId    String?
  
  provider          NotificationProviderType
  eventType         String
  
  workspaceId       String
  userId            String?
  
  // Delivery status
  status            DeliveryStatus @default(PENDING)
  attempts          Int            @default(0)
  maxAttempts       Int            @default(3)
  
  // Error tracking
  lastError         String?
  lastAttemptAt     DateTime?
  nextRetryAt       DateTime?
  
  // Success tracking
  deliveredAt       DateTime?
  
  // Payload for retry
  payload           Json?
  
  @@index([status, nextRetryAt])
  @@index([workspaceId, provider])
  @@index([createdAt])
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  RETRYING
  MAX_RETRIES_REACHED
}

// ============================================
// AEGIS - Security Incident Management Module
// ============================================

// Severity for alerts, incidents, and threats
enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

// Priority for incidents, cases, and tasks
enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

// Alert lifecycle statuses
enum AlertStatus {
  NEW
  ACKNOWLEDGED
  INVESTIGATING
  RESOLVED
  DISMISSED
}

// Incident lifecycle statuses
enum IncidentStatus {
  ACTIVE
  INVESTIGATING
  CONTAINMENT
  ERADICATION
  RECOVERY
  RESOLVED
  CLOSED
}

// Case lifecycle statuses
enum CaseStatus {
  ACTIVE
  REVIEW
  CLOSED
  ARCHIVED
}

// Observable/IOC types
enum ObservableType {
  IP
  DOMAIN
  URL
  HASH_MD5
  HASH_SHA1
  HASH_SHA256
  EMAIL
  FILE
  REGISTRY
  USER_AGENT
  OTHER
}

// Traffic Light Protocol (data sharing classification)
enum TLP {
  WHITE
  GREEN
  AMBER
  RED
}

// Permissible Actions Protocol
enum PAP {
  WHITE
  GREEN
  AMBER
  RED
}

// Evidence types
enum EvidenceType {
  EMAIL
  NETWORK
  FILE
  LOG
  SCREENSHOT
  MEMORY_DUMP
  DISK_IMAGE
  OTHER
}

// Evidence status in chain of custody
enum EvidenceStatus {
  COLLECTED
  ANALYZED
  QUARANTINED
  PRESERVED
  DELETED
}

// Hash algorithms for evidence integrity
enum HashAlgorithm {
  MD5
  SHA1
  SHA256
}

// Chain of custody actions
enum CustodyAction {
  COLLECTED
  TRANSFERRED
  ANALYZED
  STORED
  RETURNED
  ACCESSED
  MODIFIED
  DELETED
  PRESERVED
  QUARANTINED
}

// Task statuses
enum TaskStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Timeline event types
enum TimelineEventType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

// MITRE ATT&CK - Resource Types for polymorphic TTP associations
// Alert Model - Security alerts from various sources
model Alert {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  workspaceId     String
  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  title           String
  description     String
  source          String          // 'Firewall', 'IDS/IPS', 'SIEM', etc
  severity        Severity
  status          AlertStatus     @default(NEW)
  
  // Technical data
  detectedAt      DateTime        @default(now())
  category        String?         // 'malware', 'intrusion', 'data-leak', etc
  threatScore     Int?            // 0-100
  affectedAssets  String[]        @default([]) // Affected IPs, hostnames, users
  tags            String[]        @default([])
  
  // Assignment
  assignedToId    String?
  assignedTo      User?           @relation("AlertAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt      DateTime?
  
  // Threat analysis
  threatAnalysis  Json?           // {type, confidence, recommendations, relatedThreats}
  technicalDetails Json?          // Source-specific technical details
  
  // Relations
  observables     Observable[]
  incidents       Incident[]      @relation("AlertToIncident")
  timeline        TimelineEvent[]
  
  // Metadata
  metadata        Json?
  
  @@index([workspaceId, status, createdAt])
  @@index([severity, status])
  @@index([assignedToId])
}

// Incident Model - Active security incidents under investigation
model Incident {
  id                String          @id @default(uuid())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  workspaceId       String
  workspace         Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  title             String
  description       String
  severity          Severity
  status            IncidentStatus  @default(ACTIVE)
  priority          Priority        @default(MEDIUM)
  
  // SLA Management
  slaDeadline       DateTime?
  slaBreached       Boolean         @default(false)
  
  // Assignee/Team
  assignedToId      String?
  assignedTo        User?           @relation("IncidentAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  team              String?         // Responsible team name
  
  // Affected systems
  affectedSystems   String[]        @default([])
  
  // Relations
  alerts            Alert[]         @relation("AlertToIncident")
  cases             Case[]          @relation("IncidentToCase")
  observables       Observable[]
  tasks             Task[]
  timeline          TimelineEvent[]
  notes             InvestigationNote[]
  
  // Eclipse Integration
  brandInfringements BrandInfringement[] @relation("BrandInfringementIncident")
  
  // Progress tracking
  progress          Int             @default(0) // 0-100%
  
  // Response playbook
  playbookId        String?
  playbookData      Json?           // Applied playbook data
  
  // Resolution
  resolvedAt        DateTime?
  resolutionSummary String?
  
  // Metadata
  metadata          Json?
  
  @@index([workspaceId, status, createdAt])
  @@index([severity, status])
  @@index([assignedToId])
  @@index([slaDeadline])
}

// Case Model - Formal forensic investigation cases
model Case {
  id                String          @id @default(uuid())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  workspaceId       String
  workspace         Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  title             String
  description       String
  priority          Priority        @default(MEDIUM)
  status            CaseStatus      @default(ACTIVE)
  
  // Classification
  caseType          String?         // 'malware', 'phishing', 'data-breach', etc
  confidentiality   String          @default("CONFIDENTIAL") // TLP-like
  
  // Investigator
  investigatorId    String?
  investigator      User?           @relation("CaseInvestigator", fields: [investigatorId], references: [id], onDelete: SetNull)
  team              String?
  
  // Relations
  incidents         Incident[]      @relation("IncidentToCase")
  evidence          Evidence[]
  observables       Observable[]
  tasks             Task[]
  timeline          TimelineEvent[]
  notes             InvestigationNote[]
  
  // Findings
  findings          String?         // Markdown text
  recommendations   String?         // Markdown text
  
  // Closure
  closedAt          DateTime?
  closedBy          String?
  finalReport       Json?           // Structured final report
  
  // Templates
  templateId        String?
  
  // Metadata
  metadata          Json?
  
  @@index([workspaceId, status, createdAt])
  @@index([priority, status])
  @@index([investigatorId])
}

// Observable Model - Indicators of Compromise (IOCs)
model Observable {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  workspaceId     String
  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  type            ObservableType
  value           String
  dataType        String?
  
  // TLP/PAP (Traffic Light Protocol / Permissible Actions Protocol)
  tlp             TLP             @default(WHITE)
  pap             PAP             @default(WHITE)
  
  // Indicator of Compromise
  ioc             Boolean         @default(false)
  sighted         Boolean         @default(false)
  
  tags            String[]        @default([])
  description     String?
  source          String?
  
  createdById     String
  createdBy       User            @relation("ObservableCreator", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Enrichment (threat intel data)
  enrichment      Json?           // {reputation, geoLocation, threatLevel, verdicts, etc}
  
  // Relations
  alerts          Alert[]
  incidents       Incident[]
  cases           Case[]
  evidence        Evidence[]      @relation("ObservableToEvidence")
  
  @@index([workspaceId, type])
  @@index([value])
  @@index([ioc, sighted])
}

// Evidence Model - Digital evidence with chain of custody
model Evidence {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  caseId          String
  case            Case            @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  type            EvidenceType
  name            String
  description     String?
  
  // Collection
  collectedAt     DateTime        @default(now())
  collectedById   String
  collectedBy     User            @relation("EvidenceCollector", fields: [collectedById], references: [id])
  
  // Hash and integrity
  size            String          // "1.5 MB", "523 bytes", etc
  hash            String
  hashAlgorithm   HashAlgorithm   @default(SHA256)
  
  status          EvidenceStatus  @default(COLLECTED)
  location        String?
  
  tags            String[]        @default([])
  
  // Chain of Custody
  custodyLog      CustodyLog[]
  
  // Related observables
  observables     Observable[]    @relation("ObservableToEvidence")
  
  // File storage (S3/MinIO)
  fileUrl         String?
  s3Key           String?         // MinIO S3 key for direct access/cleanup
  
  metadata        Json?
  
  @@index([caseId, createdAt])
  @@index([status])
}

// CustodyLog Model - Chain of custody tracking
model CustodyLog {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  
  evidenceId      String
  evidence        Evidence        @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  
  action          CustodyAction
  userId          String
  user            User            @relation("CustodyUser", fields: [userId], references: [id])
  
  timestamp       DateTime        @default(now())
  location        String?
  notes           String?
  
  previousHash    String?
  currentHash     String
  
  ipAddress       String?
  device          String?
  signature       String?
  
  @@index([evidenceId, createdAt])
}

// Task Model - Investigation tasks and playbooks
model Task {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  title           String
  description     String?
  status          TaskStatus      @default(WAITING)
  priority        Priority        @default(MEDIUM)
  
  assigneeId      String?
  assignee        User?           @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  
  incidentId      String?
  incident        Incident?       @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  caseId          String?
  case            Case?           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  group           String?
  order           Int             @default(0)
  
  startDate       DateTime?
  dueDate         DateTime?
  completedAt     DateTime?
  completedById   String?
  
  estimatedHours  Float?
  actualHours     Float?
  
  dependencies    String[]        @default([])
  
  @@index([incidentId])
  @@index([caseId])
  @@index([status])
}

// TTP Model - MITRE ATT&CK Tactics, Techniques, and Procedures
model TTP {
  id               String   @id @default(uuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // ✅ Workspace Isolation (Multi-Tenancy)
  workspaceId      String
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Polymorphic Association - supports any resource (Case, Alert, Incident, BrandInfringement, TimelineEvent, etc)
  resourceId       String   // ID of parent entity
  resourceType     String   // Resource type: CASE, ALERT, INCIDENT, BRAND_INFRINGEMENT, TIMELINE_EVENT, ECLIPSE, etc
  
  // MITRE ATT&CK References
  tacticId         String
  tacticName       String
  techniqueId      String
  techniqueName    String
  subtechniqueId   String?
  subtechniqueName String?
  
  // Context & Metadata
  description      String?
  occurrenceCount  Int      @default(1)
  detectedAt       DateTime?
  confidence       Int?     // 0-100 confidence score
  severity         String?  // Optional severity mapping
  
  // ✅ Audit Tracking (Compliance)
  createdBy        String?
  
  // ✅ Optimized Indexes for Multi-Tenancy
  @@index([workspaceId, resourceId, resourceType])
  @@index([workspaceId, tacticId, techniqueId])
  @@index([resourceId, resourceType])
  @@index([tacticId, techniqueId])
}

// TimelineEvent Model - Chronological event tracking
model TimelineEvent {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  
  type            TimelineEventType
  title           String
  description     String
  timestamp       DateTime        @default(now())
  
  userId          String
  user            User            @relation("TimelineUser", fields: [userId], references: [id])
  
  alertId         String?
  alert           Alert?          @relation(fields: [alertId], references: [id], onDelete: Cascade)
  
  incidentId      String?
  incident        Incident?       @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  caseId          String?
  case            Case?           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  metadata        Json?
  
  @@index([alertId, timestamp])
  @@index([incidentId, timestamp])
  @@index([caseId, timestamp])
}

// InvestigationNote Model - Notes for incidents and cases
model InvestigationNote {
  id              String          @id @default(uuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  content         String
  
  authorId        String
  author          User            @relation("NoteAuthor", fields: [authorId], references: [id])
  
  incidentId      String?
  incident        Incident?       @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  caseId          String?
  case            Case?           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  @@index([incidentId, createdAt])
  @@index([caseId, createdAt])
}

// Aegis Module Configuration
model AegisConfig {
  id              String              @id @default(uuid())
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  workspaceId     String              @unique
  workspace       Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Alert Configuration
  autoEscalationEnabled Boolean         @default(true)
  autoEscalationThresholdMinutes Int    @default(60)
  maxOpenAlertsPerUser Int             @default(50)
  defaultAlertRetentionDays Int         @default(365)
  
  // SLA Configuration
  slaEnabled      Boolean             @default(true)
  defaultSlaMinutes Int               @default(240) // 4 hours
  criticalSlaMinutes Int              @default(60)  // 1 hour
  autoAssignmentEnabled Boolean        @default(false)
  
  // Notification Configuration
  emailNotificationsEnabled Boolean    @default(true)
  slackWebhookUrl String?             @db.Text
  teamsWebhookUrl String?             @db.Text
  customWebhookUrl String?            @db.Text
  
  // MITRE ATT&CK Integration
  mitreAttackSyncEnabled Boolean       @default(true)
  mitreAttackApiKey String?            @db.Text // Encrypted
  enableMitreMapping Boolean           @default(true)
  
  // Security Configuration
  evidenceEncryption Boolean           @default(true)
  auditLoggingEnabled Boolean          @default(true)
  retentionPolicyDays Int             @default(2555) // 7 years
  
  // Performance Configuration
  maxConcurrentTasks Int              @default(10)
  batchProcessingSize Int             @default(100)
  enableBackgroundProcessing Boolean   @default(true)
}

// MITRE ATT&CK Framework - Tactics
model MitreTactic {
  id            String   @id // TA0001, TA0002, etc
  name          String
  description   String   @db.Text
  url           String?
  techniques    MitreTechnique[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// MITRE ATT&CK Framework - Techniques & Sub-techniques
model MitreTechnique {
  id            String   @id // T1566, T1059, etc
  name          String
  description   String   @db.Text
  url           String?
  
  // Relations
  tacticId      String
  tactic        MitreTactic @relation(fields: [tacticId], references: [id], onDelete: Cascade)
  
  parentId      String?  // For sub-techniques
  parent        MitreTechnique? @relation("SubTechniques", fields: [parentId], references: [id], onDelete: Cascade)
  subtechniques MitreTechnique[] @relation("SubTechniques")
  
  // Metadata
  platforms     String[] // Windows, Linux, macOS, etc
  dataSources   String[]
  defenses      String[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tacticId])
  @@index([parentId])
}

// ============================================
// ECLIPSE Module - Brand Protection & Monitoring
// ============================================

model EclipseBrand {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  workspaceId           String
  workspace             Workspace       @relation("EclipseBrandWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  
  // Identificadores e marcas
  trademark             String?
  domains               String[]        @default([])
  socialMediaHandles    String[]        @default([])
  
  // Status e prioridade
  status                String          @default("active")
  priority              Int             @default(1)
  confidentiality       String          @default("public")
  
  // Monitoramento
  monitors              BrandMonitor[]
  infringements         BrandInfringement[]
  alertAggregations     BrandAlertAggregation[]
  alerts                BrandAlert[]    @relation("BrandAlerts")
  
  // Auditoria
  createdBy             String?
  lastModifiedBy        String?
  modificationHistory   ModificationHistory[]
  
  @@index([workspaceId])
  @@index([status])
  @@index([createdAt])
}

model BrandMonitor {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  brandId               String
  brand                 EclipseBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  workspaceId           String
  workspace             Workspace       @relation("BrandMonitorWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Tipo de monitoramento
  monitoringType        String
  source                String
  
  // Configuração de busca
  searchTerms           String[]
  excludeTerms          String[]        @default([])
  keywords              String[]        @default([])
  
  // Configuração geográfica
  targetRegions         String[]        @default([])
  targetLanguages       String[]        @default(["pt", "es", "en"])
  excludeRegions        String[]        @default([])
  
  // Regras de detecção
  yaraRules             String?         @db.Text
  regexPatterns         String[]        @default([])
  domainPatterns        String[]        @default([])
  
  // Critérios de severidade
  confidenceThreshold   Int             @default(70)
  matchingRulesNeeded   Int             @default(1)
  
  // Status
  status                String          @default("active")
  isAutomated           Boolean         @default(true)
  enableScreenshots     Boolean         @default(true)
  enableOCR             Boolean         @default(false)
  deepAnalysis          Boolean         @default(false)
  
  // Frequência
  checkFrequency        String          @default("daily")
  lastCheckAt           DateTime?
  nextCheckAt           DateTime?
  
  // Estatísticas
  detectionsThisMonth   Int             @default(0)
  detectionsTotalTime   Int             @default(0)
  successfulRuns        Int             @default(0)
  failedRuns            Int             @default(0)
  lastErrorMessage      String?
  
  alerts                BrandAlert[]
  
  @@index([brandId])
  @@index([workspaceId])
  @@index([status])
  @@index([nextCheckAt])
}

model BrandAlert {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  monitorId             String
  monitor               BrandMonitor    @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  
  brandId               String
  brand                 EclipseBrand    @relation("BrandAlerts", fields: [brandId], references: [id], onDelete: Cascade)
  
  workspaceId           String
  workspace             Workspace       @relation("BrandAlertWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Dados do alerta
  title                 String
  description           String?
  url                   String?
  content               String?         // HTML content or text content from the page
  screenshotUrl         String?         // Path or URL to screenshot
  severity              String
  
  // Tipo de detecção
  detectionType         String          @default("CONTENT")  // CONTENT, DOMAIN, VISUAL, OCR
  
  // Status do alerta
  status                String          @default("new")
  
  // Se foi escalado para infração
  infringementId        String?
  infringement          BrandInfringement? @relation(fields: [infringementId], references: [id], onDelete: SetNull)
  
  // Análise detalhada
  confidence            Int             @default(100)
  alertMetadata         Json?           // Metadata como tags meta, links, etc
  analysisData          Json?           // Dados da análise (regex matches, OCR, etc)
  sourceData            Json?           // Dados brutos da fonte
  
  @@index([monitorId])
  @@index([brandId])
  @@index([workspaceId])
  @@index([status])
  @@index([severity])
  @@index([detectionType])
}

model BrandInfringement {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  brandId               String
  brand                 EclipseBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  workspaceId           String
  workspace             Workspace       @relation("BrandInfringementWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Identificação
  title                 String
  description           String?
  detectionDate         DateTime        @default(now())
  
  // Localização
  url                   String
  domain                String
  ipAddress             String?
  location              String?
  
  // Tipo de infração
  type                  String
  severity              String
  
  // Status
  status                String          @default("open")
  
  // Ações e rastreamento
  actions               InfringementAction[]
  alerts                BrandAlert[]
  notes                 String[]        @default([])
  
  // Auditoria
  detectedBy            String?
  investigatedBy        String?
  resolvedAt            DateTime?
  
  // Integração com Aegis
  aegisIncidentId       String?
  incident              Incident?       @relation("BrandInfringementIncident", fields: [aegisIncidentId], references: [id], onDelete: SetNull)
  aegisSyncStatus       String          @default("pending")
  aegisSyncedAt         DateTime?
  aegisSyncError        String?
  
  @@index([brandId])
  @@index([workspaceId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([aegisIncidentId])
  @@index([aegisSyncStatus])
}

model InfringementAction {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  infringementId        String
  infringement          BrandInfringement @relation(fields: [infringementId], references: [id], onDelete: Cascade)
  
  workspaceId           String
  workspace             Workspace       @relation("InfringementActionWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Ação
  actionType            String
  title                 String
  description           String?
  
  // Status
  status                String          @default("pending")
  
  // Timeline
  plannedDate           DateTime?
  executionDate         DateTime?
  completionDate        DateTime?
  
  // Resultados
  result                String?
  evidence              String[]        @default([])
  notes                 String?
  
  // Responsabilidade
  assignedTo            String?
  priority              Int             @default(2)
  
  @@index([infringementId])
  @@index([workspaceId])
  @@index([status])
}

model BrandAlertAggregation {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  brandId               String
  brand                 EclipseBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  workspaceId           String
  workspace             Workspace       @relation("BrandAlertAggregationWorkspace", fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Agregação por período
  period                String
  date                  DateTime
  
  // Métricas
  totalAlerts           Int             @default(0)
  criticalAlerts        Int             @default(0)
  highAlerts            Int             @default(0)
  newInfringements      Int             @default(0)
  actionsCompleted      Int             @default(0)
  
  @@index([brandId])
  @@index([workspaceId])
  @@index([date])
}

model ModificationHistory {
  id                    String          @id @default(uuid())
  createdAt             DateTime        @default(now())
  
  brandId               String
  brand                 EclipseBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  
  field                 String
  oldValue              String?
  newValue              String?
  modifiedBy            String?
  
  @@index([brandId])
}

// ============================================
// FEATURE MANAGEMENT SYSTEM
// ============================================

// Feature Flag Model - Global feature configuration
model FeatureFlag {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Feature identification
  key           String   @unique  // e.g., "aegis.sla_tracking"
  name          String             // Human-readable name
  description   String?            // Feature description
  module        String             // "aegis", "eclipse", "mitre", "core"
  category      String             // "security", "analytics", "integration"
  
  // Global feature state
  isGloballyEnabled Boolean @default(true)
  
  // Plan availability
  availableInFree   Boolean @default(false)
  availableInHobby  Boolean @default(true)
  availableInPro    Boolean @default(true)
  
  // Feature metadata
  deprecated        Boolean @default(false)
  deprecationDate   DateTime?
  removalDate       DateTime?
  
  // Workspace overrides
  workspaceOverrides WorkspaceFeatureOverride[]
  
  @@index([module, isGloballyEnabled])
  @@index([key])
}

// Workspace Feature Override Model - Per-workspace feature toggles
model WorkspaceFeatureOverride {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  featureFlagId String
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)
  
  isEnabled     Boolean
  enabledById   String?
  enabledAt     DateTime?
  
  // Override reason/notes
  reason        String?
  
  @@unique([workspaceId, featureFlagId])
  @@index([workspaceId, isEnabled])
}

// Feature Usage Analytics - Track feature usage and denials
model FeatureUsageLog {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  
  workspaceId   String
  workspace     Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  featureKey    String   // e.g., "aegis.incident_management"
  userId        String?
  
  action        String   // 'check', 'use', 'denied'
  success       Boolean  @default(true)
  reason        String?  // Reason for denial
  
  metadata      Json?    // Additional context
  timestamp     DateTime @default(now())
  
  @@index([workspaceId, timestamp])
  @@index([featureKey, timestamp])
  @@index([workspaceId, featureKey, timestamp])
  @@index([action, timestamp])
}

// ============================================
// JOB CONTROL & MONITORING SYSTEM
// ============================================

// Job Control Model - Manage job execution state and scheduling
model JobControl {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  jobName       String   @unique  // e.g., "dailyStatsJob"
  
  // Execution control
  isPaused      Boolean  @default(false)
  pausedAt      DateTime?
  pausedBy      String?  // Admin user ID
  pauseReason   String?
  
  // Schedule management
  cronSchedule  String?  // Current cron expression
  originalSchedule String? // Original schedule for restore
  scheduleUpdatedAt DateTime?
  scheduleUpdatedBy String?
  
  // Metadata
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  runCount      Int      @default(0)
  failureCount  Int      @default(0)
  
  @@index([jobName, isPaused])
}

// Dead Letter Queue - Failed job executions that need manual intervention
model DeadLetterQueue {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  jobName       String
  
  // Failure details
  failedAt      DateTime @default(now())
  retryCount    Int      @default(0)
  maxRetries    Int      @default(3)
  
  // Error information
  errorMessage  String
  errorStack    String?
  
  // Job data
  jobData       Json?
  
  // Status
  status        String   @default("pending") // pending, retrying, resolved, abandoned
  resolvedAt    DateTime?
  resolvedBy    String?  // Admin user ID
  resolution    String?  // How it was resolved
  
  // Retry tracking
  lastRetryAt   DateTime?
  nextRetryAt   DateTime?
  
  @@index([jobName, status])
  @@index([status, createdAt])
  @@index([nextRetryAt])
}

