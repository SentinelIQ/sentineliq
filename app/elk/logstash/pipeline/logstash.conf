## Logstash Pipeline Configuration for SentinelIQ
## Receives JSON logs from the application and forwards to Elasticsearch

input {
  # TCP input for application logs
  tcp {
    port => 5000
    codec => json
  }
  
  # UDP input for high-throughput scenarios (optional)
  udp {
    port => 5000
    codec => json
  }
}

filter {
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
      remove_field => ["timestamp"]
    }
  }

  # Add application metadata
  mutate {
    add_field => {
      "application" => "sentineliq"
    }
  }

  # Auto-detect environment from log or use default
  if [environment] {
    mutate {
      lowercase => ["environment"]
    }
  } else {
    mutate {
      add_field => { "environment" => "${ENVIRONMENT:development}" }
    }
  }

  # Normalize environment values
  if [environment] == "prod" or [environment] == "production" {
    mutate {
      replace => { "environment" => "prod" }
    }
  } else if [environment] == "dev" or [environment] == "development" {
    mutate {
      replace => { "environment" => "dev" }
    }
  } else if [environment] == "staging" or [environment] == "stage" {
    mutate {
      replace => { "environment" => "staging" }
    }
  } else {
    # Default to dev if unknown
    mutate {
      replace => { "environment" => "dev" }
    }
  }

  # Parse log level
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # Extract workspace and user info if present
  if [workspaceId] {
    mutate {
      add_field => { "workspace_id" => "%{workspaceId}" }
      remove_field => ["workspaceId"]
    }
  }

  if [userId] {
    mutate {
      add_field => { "user_id" => "%{userId}" }
      remove_field => ["userId"]
    }
  }

  # Enrich error logs
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => ["alert"]
    }
  }

  # Parse stack traces
  if [error] {
    if [error][stack] {
      mutate {
        copy => { "[error][stack]" => "stack_trace" }
      }
    }
  }

  # Add geo IP info if IP address present
  if [ip] {
    geoip {
      source => "ip"
      target => "geoip"
    }
  }
}

output {
  # Send to Elasticsearch with environment-specific indices
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    # Automatically creates: sentineliq-logs-dev-* or sentineliq-logs-prod-*
    index => "sentineliq-logs-%{environment}-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Debug output (optional - remove in production)
  # stdout { codec => rubydebug }
}
